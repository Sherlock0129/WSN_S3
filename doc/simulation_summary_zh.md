# `proposal/main.pdf` 仿真实现说明

### 1. 概述
本次工作的核心目标是根据 `proposal/main.pdf` 的分层无线输能思想，构建一个模块化的、可扩展的 Python 仿真平台。该平台能够模拟从远距离 RF 能量源出发，经过多块 RIS 反射，最终为非视距（NLOS）环境下的无线传感器网络（WSN）簇提供能量的完整链路，并包含了簇内的近场能量分配。

### 2. 项目结构
为了保证代码的清晰和可维护性，我将项目代码组织在 `src` 目录下，并划分为以下几个功能模块：
- `config/`: 存放仿真配置文件。
- `core/`: 包含仿真世界中的核心实体对象（如环境、节点、RIS 等）。
- `network/`: 定义网络拓扑结构（如簇、整个 WSN）。
- `utils/`: 存放物理模型（如 RF 传播、MRC 耦合）。
- `routing/`: 实现能量路由算法。
- `scheduling/`: 实现跨层调度策略。
- `viz/`: 负责结果的可视化。
- `main.py`: 主仿真入口和循环。

### 3. 分步实现详解

1.  **仿真配置 (`src/config/simulation_config.py`)**
    - 创建了 `simulation_config.py` 文件，用于集中管理所有仿真参数。这包括环境尺寸、地形参数、RF 发射器功率、RIS 属性（数量、尺寸）、WSN 拓扑（簇数量、节点密度）以及仿真时长等。
    - **目的**：将参数与代码逻辑分离，便于快速调整实验设置，进行不同的场景分析。

2.  **核心组件 (`src/core/`)**
    - `Environment.py`: 实现了仿真环境。特别地，它包含一个简单的数字高程模型（DEM）来模拟山地地形，并提供了检查两点之间**视距（Line-of-Sight）**的功能，这是模拟复杂 NLOS 场景的关键。
    - `RFTransmitter.py`: 实现了 RF 能量发射器，作为系统的主要远距离能量源。
    - `RIS.py`: 实现了可重构智能表面（RIS）面板。它包含根据入射和反射点来**配置相控阵列**的逻辑，以实现波束成形，并提供了一个简化的增益计算模型。这是实现跨障碍能量路由的核心技术。
    - `SensorNode.py`: 在您提供的基础上，我为此文件增加了 `receive_mrc_power` 方法，使其能够从簇头接收近场能量。
    - `ClusterHead.py`: 实现了簇头节点。它继承自 `SensorNode`，但功能更强大：既能作为接收端，接收由 RIS 辅助的远距离 RF 能量；又能作为发射端，通过 MRC 技术为簇内成员进行近场充电。它是连接远场和近场能量传输的**桥梁**。

3.  **网络结构 (`src/network/`)**
    - `Cluster.py`: 实现了“簇”的概念，将一个簇头和多个传感器节点组织成一个逻辑单元。
    - `WSN.py`: 实现了整个无线传感器网络。它负责在初始化时创建并管理所有仿真实体（环境、发射器、RIS、所有簇），并将它们整合到一个统一的仿真对象中。

4.  **物理模型 (`src/utils/`)**
    - `rf_propagation_model.py`: 实现了远场 RF 传播模型。它包含基于 **Friis 传输方程**的自由空间路径损耗计算，以及考虑了 RIS 反射增益的两跳（源->RIS->目标）路径功率计算。
    - `mrc_model.py`: 实现了近场 MRC 模型。由于精确的电磁场仿真非常复杂，这里采用了一个简化的、基于距离的**效率衰减模型**，适用于系统级的性能评估。

5.  **能量路由 (`src/routing/routing_algorithm.py`)**
    - 实现了多 RIS 协同的能量路由算法。该算法将网络中的能量发射器、RIS 和簇头视为图节点，通过遍历不同跳数（0跳-直接传输、1跳-单次反射、2跳-两次反射）的可能路径，找出能使目标簇头接收功率最大化的**最优能量传输路径**。

6.  **调度 (`src/scheduling/scheduler.py`)**
    - 实现了跨层调度器，体现了 proposal 中的“协调”思想。它根据一个简单的能量感知策略，在每个时间步决定：
        1.  **远场充电目标**：选择当前能量最低的簇头作为 RF-RIS 系统的充电目标。
        2.  **近场充电决策**：允许自身能量高于特定阈值的簇头，对其簇内节点进行 MRC 充电。

7.  **主循环与可视化 (`src/main.py`, `src/viz/`)**
    - `main.py`: 实现了主仿真循环，将上述所有模块有机地串联起来。它按时间步推进，调用调度器和路由算法，更新网络中所有节点的能量，并记录历史数据。
    - `plot_results.py`: 实现了结果可视化功能。仿真结束后，它会自动调用此模块，使用 `matplotlib` 库绘制所有节点随时间变化的能量曲线图，并将结果保存为 `simulation_energy_results.png`。

### 4. 运行与验证
最后，我通过从项目根目录以模块化方式 (`python -m src.main`) 运行仿真，成功解决了 Python 的模块导入问题。仿真结果显示，系统稳定运行，没有任何节点因能量耗尽而“死亡”，并且最终的能量图清晰地展示了分层供能的效果，验证了该仿真框架的正确性和有效性。